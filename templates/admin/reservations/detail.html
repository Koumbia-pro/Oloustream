{# templates/admin/reservations/detail.html #}
{% extends "admin/admin_base.html" %}

{% block title %}R√©servation #{{ reservation.id }} - Admin{% endblock %}

{% block content %}

<style>
    :root {
        --adm-primary: #4f46e5;
        --adm-muted: #6b7280;
        --adm-border: #e5e7eb;
        --adm-bg: #f9fafb;
    }

    .adm-res-detail-page { margin-bottom: 2rem; }

    .adm-res-detail-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .adm-res-detail-header h1 {
        font-size: 1.4rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }

    .adm-res-detail-header small {
        font-size: 0.85rem;
        color: var(--adm-muted);
    }

    .adm-res-back-link a {
        font-size: 0.85rem;
        text-decoration: none;
        color: var(--adm-muted);
    }

    .adm-res-back-link a:hover { text-decoration: underline; }

    .adm-actions-bar {
        display: flex;
        gap: .5rem;
        flex-wrap: wrap;
        margin-top: .6rem;
    }

    .adm-res-grid {
        display: grid;
        grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.1fr);
        gap: 1rem;
    }

    @media (max-width: 992px) {
        .adm-res-grid { grid-template-columns: 1fr; }
    }

    .adm-res-card {
        background: #ffffff;
        border-radius: 1rem;
        border: 1px solid var(--adm-border);
        box-shadow: 0 8px 24px rgba(15,23,42,0.06);
        padding: 0.9rem 1rem;
        margin-bottom: 0.8rem;
    }

    .adm-card-title {
        font-size: 0.95rem;
        font-weight: 700;
        margin-bottom: 0.6rem;
    }

    .adm-field-label {
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #9ca3af;
        margin-bottom: 0.1rem;
    }

    .adm-field-value {
        font-size: 0.9rem;
        color: #111827;
        margin-bottom: 0.55rem;
    }

    .adm-field-value-muted {
        color: var(--adm-muted);
        font-size: 0.88rem;
    }

    .adm-tag {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.15rem 0.6rem;
        border-radius: 999px;
        font-size: 0.75rem;
        background: #eef2ff;
        color: #4338ca;
        margin-right: 0.3rem;
        margin-bottom: 0.25rem;
    }

    .adm-status-pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.15rem 0.7rem;
        border-radius: 999px;
        font-size: 0.78rem;
        font-weight: 600;
        letter-spacing: 0.02em;
        white-space: nowrap;
    }

    .adm-status--pending { background: #fef3c7; color: #92400e; }
    .adm-status--confirmed { background: #dcfce7; color: #166534; }
    .adm-status--cancelled { background: #fee2e2; color: #991b1b; }
    .adm-status--default { background: #e5e7eb; color: #374151; }

    .adm-history-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.82rem;
    }

    .adm-history-table th,
    .adm-history-table td {
        padding: 0.45rem 0.4rem;
        border-bottom: 1px solid var(--adm-border);
        vertical-align: top;
    }

    .adm-history-table th {
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.04em;
        color: #9ca3af;
    }

    /* Form */
    .adm-form .form-control,
    .adm-form .form-select,
    .adm-form select,
    .adm-form textarea,
    .adm-form input {
        width: 100%;
        border: 1px solid var(--adm-border);
        border-radius: 0.75rem;
        padding: 0.45rem 0.6rem;
        font-size: 0.92rem;
    }

    .adm-form textarea { min-height: 110px; }

    .adm-form .errorlist {
        margin: .25rem 0 0;
        padding-left: 1rem;
        color: #b91c1c;
        font-size: .85rem;
    }
</style>

<div class="adm-res-detail-page">
    <div class="adm-res-detail-header">
        <div>
            <div class="adm-res-back-link mb-1">
                <a href="{% url 'dashboard:reservations_list' %}">‚Üê Retour √† la liste</a>
            </div>

            <h1>R√©servation #{{ reservation.id }}</h1>

            <small>
                Cr√©√©e le {{ reservation.created_at|date:"d/m/Y H:i" }}
                {% if reservation.user %}
                    ¬∑ par {{ reservation.user.get_full_name|default:reservation.user.username }}
                    ({{ reservation.user.email }})
                {% endif %}
            </small>

            {# ‚úÖ Actions rapides POST (CONFIRMER/REFUSER/TERMINER/ANNULER) #}
            <div class="adm-actions-bar">
                {% if reservation.status == "PENDING" %}
                    <form method="post" action="{% url 'dashboard:reservations_set_status' reservation.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <input type="hidden" name="status" value="CONFIRMED">
                        <button class="btn btn-success btn-sm" type="submit">Confirmer</button>
                    </form>

                    <form method="post" action="{% url 'dashboard:reservations_set_status' reservation.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <input type="hidden" name="status" value="REJECTED">
                        <button class="btn btn-danger btn-sm" type="submit"
                                onclick="return confirm('Refuser la r√©servation #{{ reservation.id }} ?');">
                            Refuser
                        </button>
                    </form>
                {% endif %}

                {% if reservation.status == "CONFIRMED" %}
                    <form method="post" action="{% url 'dashboard:reservations_set_status' reservation.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <input type="hidden" name="status" value="COMPLETED">
                        <button class="btn btn-primary btn-sm" type="submit">Terminer</button>
                    </form>
                {% endif %}

                {% if reservation.status != "CANCELLED" and reservation.status != "REJECTED" and reservation.status != "COMPLETED" %}
                    <form method="post" action="{% url 'dashboard:reservations_set_status' reservation.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <input type="hidden" name="status" value="CANCELLED">
                        <button class="btn btn-outline-danger btn-sm" type="submit"
                                onclick="return confirm('Annuler la r√©servation #{{ reservation.id }} ?');">
                            Annuler
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>

        <div>
            {% with reservation.status as raw %}
                {% if raw == "PENDING" %}
                    <span class="adm-status-pill adm-status--pending">{{ reservation.get_status_display }}</span>
                {% elif raw == "CONFIRMED" %}
                    <span class="adm-status-pill adm-status--confirmed">{{ reservation.get_status_display }}</span>
                {% elif raw == "CANCELLED" or raw == "REJECTED" %}
                    <span class="adm-status-pill adm-status--cancelled">{{ reservation.get_status_display }}</span>
                {% else %}
                    <span class="adm-status-pill adm-status--default">{{ reservation.get_status_display }}</span>
                {% endif %}
            {% endwith %}
        </div>
    </div>

    <div class="adm-res-grid">
        <!-- COLONNE GAUCHE : INFOS -->
        <div>
            <div class="adm-res-card">
                <div class="adm-card-title">üìÖ Cr√©neau & contexte</div>

                <div class="adm-field-label">Studio / Service</div>
                <div class="adm-field-value">
                    <strong>Studio :</strong>
                    {% if reservation.studio %}{{ reservation.studio.name }}{% else %}<span class="adm-field-value-muted">‚Äî</span>{% endif %}
                    <br>
                    <strong>Service :</strong>
                    {% if reservation.service %}{{ reservation.service.name }}{% else %}<span class="adm-field-value-muted">‚Äî</span>{% endif %}
                </div>

                <div class="adm-field-label">Cr√©neau demand√©</div>
                <div class="adm-field-value">
                    Du {{ reservation.start_datetime|date:"d/m/Y H:i" }}
                    au {{ reservation.end_datetime|date:"d/m/Y H:i" }}
                </div>

                <div class="adm-field-label">Notes de planification</div>
                <div class="adm-field-value">
                    {{ reservation.scheduling_notes|default:"‚Äî"|linebreaksbr }}
                </div>
            </div>

            <div class="adm-res-card">
                <div class="adm-card-title">üß© Informations client (snapshot)</div>

                <div class="adm-field-label">Nom / structure</div>
                <div class="adm-field-value">
                    {{ reservation.contact_full_name|default:"‚Äî" }}
                    {% if reservation.contact_company %}
                        ¬∑ <span class="adm-field-value-muted">{{ reservation.contact_company }}</span>
                    {% endif %}
                </div>

                <div class="adm-field-label">Coordonn√©es</div>
                <div class="adm-field-value">
                    {% if reservation.contact_phone %}T√©l. : {{ reservation.contact_phone }}<br>{% endif %}
                    {% if reservation.contact_email %}Email : {{ reservation.contact_email }}<br>{% endif %}
                    {% if reservation.contact_city or reservation.contact_country %}
                        Localisation :
                        {{ reservation.contact_city|default:"" }}
                        {% if reservation.contact_city and reservation.contact_country %}, {% endif %}
                        {{ reservation.contact_country|default:"" }}
                    {% endif %}
                    {% if not reservation.contact_phone and not reservation.contact_email and not reservation.contact_city and not reservation.contact_country %}
                        <span class="adm-field-value-muted">Aucune coordonn√©e renseign√©e</span>
                    {% endif %}
                </div>
            </div>

            <div class="adm-res-card">
                <div class="adm-card-title">üé¨ Projet vid√©o / podcast</div>

                <div class="adm-field-label">R√©sum√© du projet</div>
                <div class="adm-field-value">
                    {{ reservation.project_summary|default:"‚Äî"|linebreaksbr }}
                </div>

                <div class="adm-field-label">R√©f√©rences / inspirations</div>
                <div class="adm-field-value">
                    {{ reservation.project_references|default:"‚Äî"|linebreaksbr }}
                </div>
            </div>

            <div class="adm-res-card">
                <div class="adm-card-title">üéôÔ∏è Format & configuration</div>

                <div class="adm-field-label">Type de format</div>
                <div class="adm-field-value">
                    {% if reservation.format_type %}
                        {{ reservation.get_format_type_display }}
                    {% else %}
                        <span class="adm-field-value-muted">Non pr√©cis√©</span>
                    {% endif %}
                </div>

                <div class="adm-field-label">Intervenants</div>
                <div class="adm-field-value">
                    {% if reservation.participants_count %}
                        {{ reservation.participants_count }} intervenant(s)
                        {% if reservation.participants_details %}
                            ¬∑ <span class="adm-field-value-muted">{{ reservation.participants_details }}</span>
                        {% endif %}
                    {% else %}
                        <span class="adm-field-value-muted">Non pr√©cis√©</span>
                    {% endif %}
                </div>

                <div class="adm-field-label">Dur√©e & volume</div>
                <div class="adm-field-value">
                    {% if reservation.episode_duration_minutes %}
                        Dur√©e moyenne : {{ reservation.episode_duration_minutes }} min<br>
                    {% endif %}
                    {% if reservation.episodes_count %}
                        Nombre d'√©pisodes : {{ reservation.episodes_count }}<br>
                    {% endif %}
                    {% if reservation.episodes_notes %}
                        <span class="adm-field-value-muted">{{ reservation.episodes_notes }}</span>
                    {% endif %}
                    {% if not reservation.episode_duration_minutes and not reservation.episodes_count and not reservation.episodes_notes %}
                        <span class="adm-field-value-muted">Non pr√©cis√©</span>
                    {% endif %}
                </div>
            </div>

            <div class="adm-res-card">
                <div class="adm-card-title">üí∞ Budget & pr√©f√©rences de contact</div>

                <div class="adm-field-label">Budget indicatif</div>
                <div class="adm-field-value">
                    {% if reservation.budget_known %}
                        Budget connu :
                        {% if reservation.budget_min %}min {{ reservation.budget_min }} FCFA{% endif %}
                        {% if reservation.budget_max %} ¬∑ max {{ reservation.budget_max }} FCFA{% endif %}
                        {% if not reservation.budget_min and not reservation.budget_max %}
                            <span class="adm-field-value-muted">(fourchette non pr√©cis√©e)</span>
                        {% endif %}
                    {% else %}
                        <span class="adm-field-value-muted">Le client souhaite √™tre conseill√©</span>
                    {% endif %}
                </div>

                <div class="adm-field-label">Pr√©f√©rences</div>
                <div class="adm-field-value">
                    {% if reservation.contact_pref_call %}<span class="adm-tag">√ätre rappel√©</span>{% endif %}
                    {% if reservation.contact_pref_meeting %}<span class="adm-tag">RDV</span>{% endif %}
                    {% if reservation.contact_pref_email_quote %}<span class="adm-tag">Devis email</span>{% endif %}
                    {% if not reservation.contact_pref_call and not reservation.contact_pref_meeting and not reservation.contact_pref_email_quote %}
                        <span class="adm-field-value-muted">Aucune pr√©f√©rence</span>
                    {% endif %}
                </div>

                <div class="adm-field-label">Message client</div>
                <div class="adm-field-value">
                    {{ reservation.client_additional_message|default:"‚Äî"|linebreaksbr }}
                </div>
            </div>
        </div>

        <!-- COLONNE DROITE : ACTIONS + √âQUIPEMENTS + HISTORIQUE -->
        <div>
            <div class="adm-res-card">
                <div class="adm-card-title">‚úÖ √âdition (admin)</div>

                <form method="post" class="adm-form" novalidate>
                    {% csrf_token %}

                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                    {% endif %}

                    <div class="mb-2">
                        <div class="adm-field-label">Statut</div>
                        {{ form.status }}
                        {{ form.status.errors }}
                    </div>

                    <div class="mb-2">
                        <div class="adm-field-label">D√©but</div>
                        {{ form.start_datetime }}
                        {{ form.start_datetime.errors }}
                    </div>

                    <div class="mb-2">
                        <div class="adm-field-label">Fin</div>
                        {{ form.end_datetime }}
                        {{ form.end_datetime.errors }}
                    </div>

                    <div class="mb-2">
                        <div class="adm-field-label">Technicien assign√©</div>
                        {{ form.assigned_technician }}
                        {{ form.assigned_technician.errors }}
                    </div>

                    <div class="mb-2">
                        <div class="adm-field-label">Commentaire admin (interne)</div>
                        {{ form.admin_comment }}
                        {{ form.admin_comment.errors }}
                    </div>

                    <button class="btn btn-primary w-100" type="submit">
                        Enregistrer les modifications
                    </button>
                </form>
            </div>

            <div class="adm-res-card">
                <div class="adm-card-title">üéõÔ∏è √âquipements r√©serv√©s</div>

                {% if reservation.equipments.count > 0 %}
                    <ul style="margin:0;padding-left:1.1rem;">
                        {% for e in reservation.equipments.all %}
                            <li style="margin-bottom:.25rem;">
                                <strong>{{ e.name }}</strong>
                                {% if e.category %}
                                    <span class="adm-field-value-muted">({{ e.category.name }})</span>
                                {% endif %}
                                {% if e.brand or e.model %}
                                    <span class="adm-field-value-muted">
                                        ‚Äî {{ e.brand|default:"" }} {{ e.model|default:"" }}
                                    </span>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="adm-field-value-muted">Aucun √©quipement</div>
                {% endif %}
            </div>

            <div class="adm-res-card">
                <div class="adm-card-title">üìú Historique de statut</div>

                {% if status_history %}
                    <table class="adm-history-table">
                        <thead>
                        <tr>
                            <th>Date</th>
                            <th>Ancien</th>
                            <th>Nouveau</th>
                            <th>Par</th>
                            <th>Note</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for h in status_history %}
                            <tr>
                                <td>{{ h.changed_at|date:"d/m/Y H:i" }}</td>
                                <td>{{ h.get_old_status_display }}</td>
                                <td>{{ h.get_new_status_display }}</td>
                                <td>
                                    {% if h.changed_by %}
                                        {{ h.changed_by.get_full_name|default:h.changed_by.username }}
                                    {% else %}
                                        <span class="adm-field-value-muted">Syst√®me / inconnu</span>
                                    {% endif %}
                                </td>
                                <td>{{ h.note|default:"" }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="adm-field-value-muted">Aucun historique de changement de statut.</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}